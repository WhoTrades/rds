# Архитектура
## Общее
RDS состоит из двух частей - веб интерйфейса и сборочных агентов
Сборочных агентов может быть сколько угодно, а веб интерфейс один
В базу данных (postgers) обращается только веб интерфейс. А сборочный агент только
получает простые команды из RabbitMq, выполняет их и возвращает результат выполнения

Система подстроена исходя из того, что на серверах находится одновременно несколько версий приложения, и мы можем переключаться между ними

## Основные понятия
 * **Сборка версии** - это весь процесс, от выкачивания исходных кодов их системы контроля версий до запуска утилит по скачиванию зависимостей/сборки статистики и т.д. В результате сборки версии должна получиться папка, которую можно загрузить на сервер, нацелить на неё web сервер - и она будет работать
 * **Активация версии** - процесс переключения активной версии проекта. Обычно делается с помощью переключения символической ссылки
 * **Откат сборки** - вырожденный случай активации, когда активируется более старая версия
 * **SQL миграции** - процесс выполнения миграций. Предусмотрено наличие pre миграций и post миграций. [Подробнее о мигряциях](https://github.com/Whotrades/RDS/blob/master/docs/migration.md). 
 * **Сборка мусора** - Процесс удаления старых сборок, которые уже не нужны 

## Фоновые процессы
Веб интерфейс частичн работает в фоновом режиме с помощью консольных утилит, запускаемых через cron
Сборочные агенты при этом целиком являются набором консольных утилит, которые
слушают очередь и выполняют задачи (сборка версии, активация версии, заливка версии на сервера и т.д.)

#### Список фоновых процессов WEB интерфейса
 * `php yii.php deploy/index` - крон, который слушает ответы сборочного агента о фотках успешной/неуспешной сборки, о фактах активации сборок и тому подобное
 * `php yii.php remove-packages/index` - крон, который анализирует какие сборки уже не нужны и инициирует задачи по их удалению (непосредственно удалять будет сборочный агент)
 
#### Список фоновых процессов сборочного агента
 * `php yii.php deploy/index` - процесс, который занимается непосредственно сборкой версии и заливкой её на сервера
 * `php yii.php use/index` - процесс, который занимается активацией сборок и их откатом
 * `php yii.php killer/index` - процесс, который отменяет запущенные сборки
 * `php yii.php migration/index` - процесс для запуска миграций
 * `php yii.php garbage-collector/index` - процесс для удаления устаревших сборок (слушает пакеты от remove-packages/index)

